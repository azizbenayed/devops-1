pipeline {
    agent any

    tools {
        nodejs 'node20'
    }

    environment {
        IMAGE_NAME = "aziz/microservice-2"
        IMAGE_TAG  = "1.0"
        CONTAINER_NAME = "authentication"
    }

    options {
        timestamps()
    }

    stages {

        stage('Install Dependencies') {
            steps {
                echo 'üì¶ Installing Node.js dependencies...'
                sh 'node -v'
                sh 'npm install'
            }
        }

        stage('SonarQube Analysis') {
            steps {
                script {
                    def scannerHome = tool 'sonar-scanner'
                    withSonarQubeEnv('sonarqube') {
                        sh "${scannerHome}/bin/sonar-scanner"
                    }
                }
            }
        }

        stage('Dependency Check (OWASP)') {
            steps {
                script {
                    def odcHome = tool 'dependency-check'

                    withCredentials([string(credentialsId: 'nvd-api-key', variable: 'NVD_KEY')]) {
                        sh """
                            ${odcHome}/bin/dependency-check.sh \
                            --project microservice-2 \
                            --scan . \
                            --format HTML \
                            --out dependency-check-report \
                            --disableYarnAudit \
                            --nvdApiKey $NVD_KEY \
                            --failOnCVSS 7
                        """
                    }
                }

                publishHTML([
                    reportName: 'Dependency Check Report',
                    reportDir: 'dependency-check-report',
                    reportFiles: 'dependency-check-report.html',
                    keepAll: true,
                    alwaysLinkToLastBuild: true,
                    allowMissing: true
                ])
            }
        }

        stage('Build Docker Image') {
            steps {
                echo 'üê≥ Building Docker image...'
                sh 'docker build -t $IMAGE_NAME:$IMAGE_TAG .'
            }
        }

       stage('Trivy Security Scan') {
    steps {
        echo 'üîê Scanning Docker image with Trivy...'

        sh '''
            mkdir -p trivy-report

            # Scan image -> JSON
            trivy image \
            --scanners vuln \
            --format json \
            -o trivy-report/trivy-report.json \
            $IMAGE_NAME:$IMAGE_TAG

            # Start HTML file
            cat > trivy-report/trivy-report.html <<EOF
<html>
<head>
    <title>Trivy Security Report</title>
    <style>
        body { font-family: Arial; margin: 30px; background:#f4f4f4; }
        pre { background:white; padding:20px; border-radius:8px; overflow:auto; }
    </style>
</head>
<body>
    <h1>üîê Trivy Security Scan Report</h1>
    <pre>
EOF

            # Insert JSON content
            cat trivy-report/trivy-report.json >> trivy-report/trivy-report.html

            # Close HTML file
            cat >> trivy-report/trivy-report.html <<EOF
    </pre>
</body>
</html>
EOF
        '''
    }
}


        stage('Publish Trivy Report') {
            steps {
                publishHTML([
                    reportName: 'Trivy Security Report',
                    reportDir: 'trivy-report',
                    reportFiles: 'trivy-report.html',
                    keepAll: true,
                    alwaysLinkToLastBuild: true,
                    allowMissing: false
                ])
            }
        }
    }

    post {
        always {
            echo 'üßπ Cleaning test container'
            sh 'docker rm -f $CONTAINER_NAME || true'
        }

        success {
            echo '‚úÖ CI PIPELINE SUCCESS'
        }

        failure {
            echo '‚ùå CI PIPELINE FAILED'
        }
    }
}
